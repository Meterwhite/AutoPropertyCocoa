//
//  APCProperty.h
//  AutoPropertyCocoa
//
//  Created by Novo on 2019/3/14.
//  Copyright Â© 2019 Novo. All rights reserved.
//

#import "APCScope.h"

typedef NS_OPTIONS (NSUInteger,APCPropertyAccessOptions){
    
    APCPropertyKVCDisable          =   0,
    ///Getter from property attributes.
    APCPropertyComponentOfGetter   =   1   <<  0,
    
    APCPropertyComponentOfSetter   =   1   <<  1,
    
    APCPropertyComponentOfIVar     =   1   <<  2,
    ///Setter from property list.
    APCPropertyAssociatedSetter    =   1   <<  3,
    ///Ivar from ivar list.
    APCPropertyAssociatedIVar      =   1   <<  4,
    
    APCPropertySetValueEnable      =   APCPropertyComponentOfSetter
                                        | APCPropertyAssociatedSetter
                                        | APCPropertyComponentOfIVar,
    
    APCPropertyGetValueEnable      =   APCPropertyComponentOfGetter
                                        | APCPropertyComponentOfIVar,
};

typedef NS_OPTIONS(NSUInteger,APCPropertyValueKind){

    APCPropertyValueKindOfObject        =   1,
    ///C number
    APCPropertyValueKindOfNumber        =   2,
    
    APCPropertyValueKindOfStructure     =   3,
    
    APCPropertyValueKindOfSEL           =   4,
    
    APCPropertyValueKindOfPoint         =   5,
    ///char*
    APCPropertyValueKindOfChars         =   6,
    
    APCPropertyValueKindOfBlock         =   7,
};

typedef NS_OPTIONS(NSUInteger, APCPropertyOwnerKind){
    
    APCPropertyOwnerKindOfClass       =   0,
    
    APCPropertyOwnerKindOfInstance    =   1,
};

typedef NS_OPTIONS(NSUInteger, APCPropertyHookKind){
    
    APCPropertyHookKindOfEmpty     =   0,
    
    APCPropertyHookKindOfSelector  =   1,
    
    APCPropertyHookKindOfBlock     =   2,
    
    APCPropertyHookKindOfIMP       =   3,
};

@interface APCProperty : NSObject
{
@public
    
    NSUInteger              _hashcode;
    Class                   _des_class;
    Class                   _src_class;
    NSString*               _ori_property_name;//user
    NSString*               _des_getter_name;//property getter
    NSString*               _des_setter_name;//property setter
    __weak id               _instance;
@protected
    
    APCPropertyHookKind     _kindOfUserHook;
    APCPropertyOwnerKind    _kindOfOwner;
@private
    
    BOOL                    _enable;
}



@property (nonatomic,assign,readonly)APCPropertyHookKind       kindOfUserHook;
@property (nonatomic,assign,readonly)APCPropertyAccessOptions  accessOption;
@property (nonatomic,assign,readonly)APCPropertyOwnerKind      kindOfOwner;
@property (nonatomic,assign,readonly)APCPropertyValueKind      kindOfValue;
@property (nonatomic,assign,readonly)BOOL                      isReadonly;
@property (nonatomic,assign,readonly)objc_AssociationPolicy    policy;
@property (nonatomic,assign,readonly)BOOL                      enable;

+ (instancetype _Nonnull)instanceWithProperty:(NSString* _Nonnull)property
                                    aInstance:(id _Nonnull)aInstance;

+ (instancetype _Nonnull)instanceWithProperty:(NSString* _Nonnull)property
                                       aClass:(Class _Nonnull __unsafe_unretained)aClass;

- (instancetype _Nonnull)initWithPropertyName:(NSString* _Nonnull)propertyName
                        aInstance:(id _Nonnull)aInstance;

- (instancetype _Nonnull)initWithPropertyName:(NSString* _Nonnull)propertyName
                                       aClass:(Class _Nonnull __unsafe_unretained)aClass;


- (id _Nullable)getIvarValueFromTarget:(_Nonnull id)target;

/**
 Return NO if the object is marked with 'id'.Return YES otherwise.
 */
@property (nonatomic,assign,readonly,nullable)Class   propertyClass;
@property (nonatomic,assign,readonly,nullable)SEL     propertyGetter;
@property (nonatomic,assign,readonly,nullable)SEL     propertySetter;
@property (nonatomic,assign,readonly)BOOL hasKindOfClass;

/**
 Get setter that generated by compiler.
 */
@property (nonatomic,assign,readonly,nullable)SEL     associatedSetter;

/**
 The type written by programmer.Like @"int" , @"NSString".
 */
@property (nonatomic,copy,readonly,nonnull)NSString* programmingType;
@property (nonatomic,copy,readonly,nonnull)NSString* valueAttibute;
@property (nonatomic,copy,readonly,nonnull)NSString* valueTypeEncoding;
@property (nonatomic,assign,readonly,nullable)Ivar   associatedIvar;


/**
 Befor unhook property and remove property from cache.
 */
- (void)invalid;

/**
 Call it when it is accessed.
 */
- (void)access;
- (NSUInteger)accessCount;


/**
 [obj isEqual: @"Srcclass/Desclass.property"] => YES
 */
- (BOOL)isEqual:(id _Nonnull)object;

/**
 OriginalClass/TargetClass.UserProperty
 */
- (NSUInteger)hash;
@end

